#include "GFX.h"

const uint8_t font_8x5[] =
	{
		8,
		5, // height, width
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x00,
		0x5F,
		0x00,
		0x00,
		0x00,
		0x07,
		0x00,
		0x07,
		0x00,
		0x14,
		0x7F,
		0x14,
		0x7F,
		0x14,
		0x24,
		0x2A,
		0x7F,
		0x2A,
		0x12,
		0x23,
		0x13,
		0x08,
		0x64,
		0x62,
		0x36,
		0x49,
		0x56,
		0x20,
		0x50,
		0x00,
		0x08,
		0x07,
		0x03,
		0x00,
		0x00,
		0x1C,
		0x22,
		0x41,
		0x00,
		0x00,
		0x41,
		0x22,
		0x1C,
		0x00,
		0x2A,
		0x1C,
		0x7F,
		0x1C,
		0x2A,
		0x08,
		0x08,
		0x3E,
		0x08,
		0x08,
		0x00,
		0x80,
		0x70,
		0x30,
		0x00,
		0x08,
		0x08,
		0x08,
		0x08,
		0x08,
		0x00,
		0x00,
		0x60,
		0x60,
		0x00,
		0x20,
		0x10,
		0x08,
		0x04,
		0x02,
		0x3E,
		0x51,
		0x49,
		0x45,
		0x3E,
		0x00,
		0x42,
		0x7F,
		0x40,
		0x00,
		0x72,
		0x49,
		0x49,
		0x49,
		0x46,
		0x21,
		0x41,
		0x49,
		0x4D,
		0x33,
		0x18,
		0x14,
		0x12,
		0x7F,
		0x10,
		0x27,
		0x45,
		0x45,
		0x45,
		0x39,
		0x3C,
		0x4A,
		0x49,
		0x49,
		0x31,
		0x41,
		0x21,
		0x11,
		0x09,
		0x07,
		0x36,
		0x49,
		0x49,
		0x49,
		0x36,
		0x46,
		0x49,
		0x49,
		0x29,
		0x1E,
		0x00,
		0x00,
		0x14,
		0x00,
		0x00,
		0x00,
		0x40,
		0x34,
		0x00,
		0x00,
		0x00,
		0x08,
		0x14,
		0x22,
		0x41,
		0x14,
		0x14,
		0x14,
		0x14,
		0x14,
		0x00,
		0x41,
		0x22,
		0x14,
		0x08,
		0x02,
		0x01,
		0x59,
		0x09,
		0x06,
		0x3E,
		0x41,
		0x5D,
		0x59,
		0x4E,
		0x7C,
		0x12,
		0x11,
		0x12,
		0x7C,
		0x7F,
		0x49,
		0x49,
		0x49,
		0x36,
		0x3E,
		0x41,
		0x41,
		0x41,
		0x22,
		0x7F,
		0x41,
		0x41,
		0x41,
		0x3E,
		0x7F,
		0x49,
		0x49,
		0x49,
		0x41,
		0x7F,
		0x09,
		0x09,
		0x09,
		0x01,
		0x3E,
		0x41,
		0x41,
		0x51,
		0x73,
		0x7F,
		0x08,
		0x08,
		0x08,
		0x7F,
		0x00,
		0x41,
		0x7F,
		0x41,
		0x00,
		0x20,
		0x40,
		0x41,
		0x3F,
		0x01,
		0x7F,
		0x08,
		0x14,
		0x22,
		0x41,
		0x7F,
		0x40,
		0x40,
		0x40,
		0x40,
		0x7F,
		0x02,
		0x1C,
		0x02,
		0x7F,
		0x7F,
		0x04,
		0x08,
		0x10,
		0x7F,
		0x3E,
		0x41,
		0x41,
		0x41,
		0x3E,
		0x7F,
		0x09,
		0x09,
		0x09,
		0x06,
		0x3E,
		0x41,
		0x51,
		0x21,
		0x5E,
		0x7F,
		0x09,
		0x19,
		0x29,
		0x46,
		0x26,
		0x49,
		0x49,
		0x49,
		0x32,
		0x03,
		0x01,
		0x7F,
		0x01,
		0x03,
		0x3F,
		0x40,
		0x40,
		0x40,
		0x3F,
		0x1F,
		0x20,
		0x40,
		0x20,
		0x1F,
		0x3F,
		0x40,
		0x38,
		0x40,
		0x3F,
		0x63,
		0x14,
		0x08,
		0x14,
		0x63,
		0x03,
		0x04,
		0x78,
		0x04,
		0x03,
		0x61,
		0x59,
		0x49,
		0x4D,
		0x43,
		0x00,
		0x7F,
		0x41,
		0x41,
		0x41,
		0x02,
		0x04,
		0x08,
		0x10,
		0x20,
		0x00,
		0x41,
		0x41,
		0x41,
		0x7F,
		0x04,
		0x02,
		0x01,
		0x02,
		0x04,
		0x40,
		0x40,
		0x40,
		0x40,
		0x40,
		0x00,
		0x03,
		0x07,
		0x08,
		0x00,
		0x20,
		0x54,
		0x54,
		0x78,
		0x40,
		0x7F,
		0x28,
		0x44,
		0x44,
		0x38,
		0x38,
		0x44,
		0x44,
		0x44,
		0x28,
		0x38,
		0x44,
		0x44,
		0x28,
		0x7F,
		0x38,
		0x54,
		0x54,
		0x54,
		0x18,
		0x00,
		0x08,
		0x7E,
		0x09,
		0x02,
		0x18,
		0xA4,
		0xA4,
		0x9C,
		0x78,
		0x7F,
		0x08,
		0x04,
		0x04,
		0x78,
		0x00,
		0x44,
		0x7D,
		0x40,
		0x00,
		0x20,
		0x40,
		0x40,
		0x3D,
		0x00,
		0x7F,
		0x10,
		0x28,
		0x44,
		0x00,
		0x00,
		0x41,
		0x7F,
		0x40,
		0x00,
		0x7C,
		0x04,
		0x78,
		0x04,
		0x78,
		0x7C,
		0x08,
		0x04,
		0x04,
		0x78,
		0x38,
		0x44,
		0x44,
		0x44,
		0x38,
		0xFC,
		0x18,
		0x24,
		0x24,
		0x18,
		0x18,
		0x24,
		0x24,
		0x18,
		0xFC,
		0x7C,
		0x08,
		0x04,
		0x04,
		0x08,
		0x48,
		0x54,
		0x54,
		0x54,
		0x24,
		0x04,
		0x04,
		0x3F,
		0x44,
		0x24,
		0x3C,
		0x40,
		0x40,
		0x20,
		0x7C,
		0x1C,
		0x20,
		0x40,
		0x20,
		0x1C,
		0x3C,
		0x40,
		0x30,
		0x40,
		0x3C,
		0x44,
		0x28,
		0x10,
		0x28,
		0x44,
		0x4C,
		0x90,
		0x90,
		0x90,
		0x7C,
		0x44,
		0x64,
		0x54,
		0x4C,
		0x44,
		0x00,
		0x08,
		0x36,
		0x41,
		0x00,
		0x00,
		0x00,
		0x77,
		0x00,
		0x00,
		0x00,
		0x41,
		0x36,
		0x08,
		0x00,
		0x02,
		0x01,
		0x02,
		0x04,
		0x02,
};

// Initializer function replacing the C++ constructor
void GFX_init(GFX *self, uint16_t DevAddr, uint8_t width, uint8_t height, i2c_inst_t *i2c, uint8_t resetPin)
{
	SSD1309_create(&(self->base), DevAddr, width, height, i2c, resetPin);
	self->font = font_8x5;
	self->size = 1;
}

void GFX_drawChar(GFX *self, int x, int y, char chr, colors color)
{
	if (chr > 0x7E)
		return;

	for (uint8_t i = 0; i < self->font[1]; i++)
	{
		uint8_t line = self->font[(chr - 0x20) * self->font[1] + i + 2];

		for (int8_t j = 0; j < self->font[0]; j++, line >>= 1)
		{
			if (line & self->size == 1)
			{
				SSD1309_drawPixel(&(self->base), x + i, y + j, color);
			}
		}
	}
}

void GFX_drawCharArray(GFX *self, int x, int y, char *str, colors color)
{
	int x_tmp = x;
	char znak;
	znak = *str;
	while (*str++)
	{
		GFX_drawChar(self, x_tmp, y, znak, color);
		x_tmp += (self->font[1] * self->size) + 1;
		znak = *str;
	}
}

void GFX_drawString(GFX *self, int x, int y, const char *str, colors color)
{
	int x_tmp = x;
	const char *p = str;

	while (*p)
	{
		GFX_drawChar(self, x_tmp, y, *p++, color);
		x_tmp += (self->font[1] * self->size) + 1;
	}
}

void GFX_drawRectangle(GFX *self, int x, int y, uint16_t w, uint16_t h, colors color)
{
	GFX_drawFastHLine(self, x, y, w, color);
	GFX_drawFastHLine(self, x, y + h - 1, w, color);
	GFX_drawFastVLine(self, x, y, h, color);
	GFX_drawFastVLine(self, x + w - 1, y, h, color);
}

void GFX_drawFillRectangle(GFX *self, int x, int y, uint16_t w, uint16_t h, colors color)
{
	for (int i = x; i < x + w; i++)
	{
		GFX_drawFastVLine(self, i, y, h, color);
	}
}

void GFX_drawProgressBar(GFX *self, int x, int y, uint16_t w, uint16_t h, uint8_t progress, colors color)
{
	if (progress < 0)
		progress = 0;
	if (progress > 100)
		progress = 100;
	GFX_drawRectangle(self, x, y, w, h, color);
	GFX_drawFillRectangle(self, x, y, (w * progress) / 100, h, color);
}

void GFX_drawFastVLine(GFX *self, int x_start, int y_start, int h, colors color)
{
	GFX_writeLine(self, x_start, y_start, x_start, y_start + h - 1, color);
}

void GFX_drawFastHLine(GFX *self, int x_start, int y_start, int w, colors color)
{
	GFX_writeLine(self, x_start, y_start, x_start + w - 1, y_start, color);
}

void GFX_writeLine(GFX *self, int x_start, int y_start, int x_end, int y_end, colors color)
{
	int16_t steep = abs(y_end - y_start) > abs(x_end - x_start);

	if (steep)
	{
		_swap_int(x_start, y_start);
		_swap_int(x_end, y_end);
	}

	if (x_start > x_end)
	{
		_swap_int(x_start, x_end);
		_swap_int(y_start, y_end);
	}

	int16_t dx = x_end - x_start;
	int16_t dy = abs(y_end - y_start);
	int16_t err = dx / 2;
	int16_t ystep = (y_start < y_end) ? 1 : -1;

	for (; x_start <= x_end; x_start++)
	{
		if (steep)
		{
			SSD1309_drawPixel(&(self->base), y_start, x_start, color);
		}
		else
		{
			SSD1309_drawPixel(&(self->base), x_start, y_start, color);
		}
		err -= dy;
		if (err < 0)
		{
			y_start += ystep;
			err += dx;
		}
	}
}
